<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/load-image.min.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.ui.widget.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.iframe-transport.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload-process.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload-image.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload-audio.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload-video.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload-validate.js)}"></script>
<script type="text/javascript" src="{uri_resource(/js/jQueryFileUpload/jquery.fileupload-ui.js)}"></script>

{if !hideHeading}
<p class="lead">
    [[ translation : marketplace : user.media.attachments :: Anhänge ]]
</p>
{endif}

{if !hideTabs}
<ul class="nav nav-tabs" id="userMediaTab">
{if allowImages}
    <li class="active">
        <a href="#images">[[ translation : marketplace : user.media.images :: Bilder ]]</a>
    </li>
{endif}
{if allowUploads}
    <li{if !allowImages} class="active"{endif}>
        <a href="#documents">[[ translation : marketplace : user.media.uploads :: Dokumente ]]</a>
    </li>
{endif}
{if allowVideos}
    <li{if !allowImages && !allowUploads} class="active"{endif}>
        <a href="#videos">[[ translation : marketplace : user.media.videos :: Videos ]]</a>
    </li>
{endif}
</ul>
{endif}

<div class="tab-content design-user-media">
    {if allowImages}
    <div class="tab-pane active" id="images">
        <div id="list_images" class="clearfix">
            {images}
        </div>

        <div id="upload_avaible_image">
            <strong>[[ translation : marketplace : ad.create.media.image.upload :: Bild hochladen: ]]</strong>
            {if !hidePacketText}
            <p>
                <span id="images_free">
                [[ translation : marketplace : ad.create.media.image.notice.free ::
                    Die ersten <strong><span id="images_free_count">{images_free}</span> Bilder</strong>
                    sind kostenlos, f&uuml;r jedes weitere wird Ihnen ein Bild von Ihrem Bilderpaket abgezogen.
                ]]
                </span><br />
                [[ translation : marketplace : ad.create.media.image.notice.overall ::
                Sie k&ouml;nnen insgesamt bis zu <strong><span id="images_max">{images_limit}</span> Bilder</strong> hochladen.
                ]]
                <br />
                [[ translation : marketplace : ad.create.media.image.notice.left ::
                Noch <strong><span id="images_left">{images_available}</span> Bild-Upload(s)</strong> möglich.
                ]]
            </p>
            {endif}
            <input id="uploadImages" type="file" name="image" multiple="">
            [[ translation : marketplace : ad.create.media.image.formats :: Akzeptierte Bildformate: jpg/jpeg, png und gif ]]<br />
            [[ translation : marketplace : ad.create.media.size.limit :: Maximale Dateigröße: {filesize({UPLOAD_MAX_FILESIZE})} ]]
        </div>
        <div id="error_image" class="alert alert-danger hide">
            [[ translation : marketplace : ad.create.media.image.notice.maximum.reached ::
            Sie haben die Maximale Anzahl von Bilder erreicht!<br>
            Um andere Bilder hochzuladen, müssen Sie mindestens ein Bild löschen
            ]]
        </div>
    </div>
    {endif}
    {if allowUploads}
    <div class="tab-pane{if hideTabs || !allowImages} active{endif}" id="documents">
        <div id="list_documents">
            {downloads}
        </div>
        <div id="uploadDocumentErrors">

        </div>

        <div id="upload_avaible_document">
            <strong>[[ translation : marketplace : ad.create.media.document.upload :: Datei hochladen: ]]</strong>
            {if !hidePacketText}
            <p>
                <span id="documents_free">
                [[ translation : marketplace : ad.create.media.document.notice.free ::
                    Die ersten <strong><span id="documents_free_count">{downloads_free}</span> Uploads</strong> sind kostenlos,
                    für jeden weiteren wird ihnen ein Upload von ihrem Uploadpaket abgezogen.
                ]]
                </span><br />
                [[ translation : marketplace : ad.create.media.document.notice.overall ::
                Sie k&ouml;nnen insgesamt bis zu <strong><span id="documents_max">{downloads_limit}</span> Dokumente</strong> hochladen.
                ]]
                <br />
                [[ translation : marketplace : ad.create.media.document.notice.left ::
                Noch <strong><span id="documents_left">{downloads_available}</span> Datei-Upload(s)</strong> m&ouml;glich.
                ]]
                <br />
            </p>
            {endif}
            <input id="uploadDocuments" type="file" name="document" multiple="">
            [[ translation : marketplace : ad.create.media.document.formats :: Akzeptierte Dateiformate: ]] <span id="documents_format">{htm(downloads_formats)}</span><br />
            [[ translation : marketplace : ad.create.media.size.limit :: Maximale Dateigröße: {filesize({UPLOAD_MAX_FILESIZE})} ]]
        </div>
        <div id="error_document" class="alert alert-danger hide">
            [[ translation : marketplace : ad.create.media.document.notice.maximum.reached ::
            Sie haben die Maximale Anzahl von Dokumenten erreicht!<br>
            Um andere Dokumente hochzuladen, müssen Sie mindestens ein Dokument löschen
            ]]
        </div>
    </div>
    {endif}
    {if allowVideos}
    <div class="tab-pane{if hideTabs || (!allowImages && !allowUploads)} active{endif}" id="videos">
        <div id="list_videos" class="clearfix">
            {if videos}
            {videos}
            {else}
            <strong class="text-error">[[ translation : marketplace : no.videos :: Keine Videos vorhanden. ]]</strong>
            {endif}
        </div>
        <div id="upload_avaible_video">

            <strong>[[ translation : marketplace : ad.create.media.video.upload :: Video eintragen: ]]</strong>
            {if !hidePacketText}
            <p>
                <span id="videos_free">
                [[ translation : marketplace : ad.create.media.video.notice.free ::
                    Die ersten <strong><span id="videos_free_count">{videos_free}</span> Videos</strong> sind kostenlos,
                    für jedes weitere wird ihnen ein Video von ihrem Anzeigenpaket abgezogen.
                ]]
                </span><br />
                [[ translation : marketplace : ad.create.media.video.notice.overall ::
                Sie k&ouml;nnen insgesamt bis zu <strong><span id="videos_max">{videos_limit}</span> Videos</strong> eintragen.
                ]]
                <br />
                [[ translation : marketplace : ad.create.media.video.notice.left ::
                Noch <strong><span id="videos_left">{videos_available}</span> Video(s)</strong> m&ouml;glich.
                ]]
                <br />
            </p>
            {endif}
            {youtube_input(youtube_url,40,youtube,0)}
            <button onclick="YoutubeSubmitVideo(); return false;">[[ translation : marketplace : user.media.video.submit :: Video hinzufügen ]]</button>
        </div>
        <div id="error_video" class="alert alert-danger hide">
            [[ translation : marketplace : ad.create.media.video.notice.maximum.reached ::
            Sie haben die Maximale Anzahl von Videos erreicht!<br>
            Um andere Videos hinzuzufügen, müssen Sie mindestens ein Video löschen
            ]]
        </div>
    </div>
    {endif}
</div>

{if allowImages}
<script id="templateImageUpload" type="text/html">
    <tr>
        <td>
            <strong>[[ translation : marketplace : please.wait :: Bitte warten... ]]</strong>
        </td>
        <td>
            [[ translation : marketplace : ad.create.media.upload.active :: Wird hochgeladen... ]]
        </td>
        <td>
            <div class="progress progress-success">
                <div class="progress-bar bar"></div>
            </div>
        </td>
    </tr>
</script>
<script id="templateImageDownload" type="text/html">
    {subtpl(tpl/{SYS_TPL_LANG}/{tplImagesRow},i=#IMAGE_INDEX#,TYPE=#IMAGE_TYPE#,BASE64=#IMAGE_DATA#)}
</script>
{endif}
{if allowUploads}
<script id="templateDocumentUpload" type="text/html">
    <tr>
        <td>
            #UPLOAD_FILE# (#UPLOAD_TYPE#)
        </td>
        <td>
            [[ translation : marketplace : ad.create.media.upload.active :: Wird hochgeladen... ]]
        </td>
        <td>

            <div class="progress progress-success">
                <div class="progress-bar bar"></div>
            </div>
        </td>
    </tr>
</script>
<script id="templateDocumentDownload" type="text/html">
    {subtpl(tpl/{SYS_TPL_LANG}/my-user-media-documents.row.htm,i=#UPLOAD_INDEX#,EXT=#UPLOAD_TYPE#,FILENAME=#UPLOAD_FILE#,FILENAME_SHORT=#UPLOAD_FILE#)}
</script>
{endif}
<script id="templateError" type="text/html">
    <div class="align-center alert alert-danger">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <strong>[[ translation : general : error :: Fehler ]]!</strong>
        #ERRORS#
    </div>
</script>
<script type="text/javascript">

    jQuery(function () {
        jQuery('#userMediaTab a').click(function (e) {
            e.preventDefault();
            jQuery(this).tab('show');
        });
        // Update media usage
        UploadRefresh();
    })

    function YoutubeSubmitVideo() {
        var code = jQuery("input[name=youtube_url]").val();
        jQuery.post(
                ebiz_trader_baseurl + 'index.php?page={htm(curpage)}&mode=ajax&is_user_media=1&do=upload',
                "ID={ID}&TABLE={htm(TABLE)}&youtube_url="+encodeURIComponent(code),
                function(result) {
                    jQuery("#list_videos").html(result);
                    // Kontingent updaten
                    UploadRefresh();
                }
        );
    }

    function ImageSetDefault(id_image) {
        jQuery.post(
                document.location.href,
                'mode=ajax&is_user_media=1&do=upload&action=image_default&id='+id_image,
                function(result) {
                    jQuery("#uploadImageTable tbody").html( jQuery(result).find("tbody").html() );
                }
        );
    }

    function ImageDelete(id_image) {
        jQuery.post(
                document.location.href,
                'mode=ajax&is_user_media=1&do=upload&action=image_delete&id='+id_image,
                function(result) {
                    jQuery("#uploadImageTable tbody").html( jQuery(result).find("tbody").html() );
                    if (jQuery("#uploadImageTable tbody tr").length == 0) {
                        // Hide table, show "no uploads yet" notice
                        jQuery("#uploadImageNoneYet").show();
                        jQuery("#uploadImageTable").hide();
                    }
                    // Update media usage
                    UploadRefresh();
                }
        );
    }

    function DocumentDelete(id_document) {
        jQuery.post(
                document.location.href,
                'mode=ajax&is_user_media=1&do=upload&action=document_delete&id='+id_document,
                function(result) {
                    jQuery("#uploadDocumentTable tbody").html( jQuery(result).find("tbody").html()  );
                    if (jQuery("#uploadDocumentTable tbody tr").length == 0) {
                        // Hide table, show "no uploads yet" notice
                        jQuery("#uploadDocumentNoneYet").show();
                        jQuery("#uploadDocumentTable").hide();
                    }
                    // Update media usage
                    UploadRefresh();
                }
        );
    }

    function VideoDelete(id_video) {
        var id_ad = jQuery("#form_ID_AD").val();
        jQuery.post(
                document.location.href,
                'mode=ajax&is_user_media=1&do=upload&action=video_delete&id='+id_video,
                function(result) {
                    jQuery("#list_videos").html(result);
                    // Update media usage
                    UploadRefresh();
                }
        );
    }

    function UploadRefresh() {
        jQuery.post(
                ebiz_trader_baseurl + 'index.php?page={curpage}&mode=ajax&is_user_media=1&do=getMediaUsage', {
                    // POST-Parameter
                    TABLE: '{TABLE}',
                    ID: {int(ID)}
                }, function(result) {
                    // Bilder
                    if (result.images_free > 0) {
                        jQuery("#images_free").show();
                        jQuery("#images_free_count").html(result.images_free);
                    } else {
                        jQuery("#images_free").hide();
                    }
                    if (result.images_available > 0) {
                        jQuery("#upload_avaible_image").show();
                        jQuery("#error_image").hide();
                        jQuery("#images_left").html(result.images_available);
                        jQuery("#images_max").html(result.images_limit);
                    } else {
                        jQuery("#upload_avaible_image").hide();
                        jQuery("#error_image").show();
                    }
                    // Dokumente
                    if (result.downloads_free > 0) {
                        jQuery("#documents_free").show();
                        jQuery("#documents_free_count").html(result.downloads_free);
                    } else {
                        jQuery("#documents_free").hide();
                    }
                    if (result.downloads_available > 0) {
                        jQuery("#upload_avaible_document").show();
                        jQuery("#error_document").hide();
                        jQuery("#documents_left").html(result.downloads_available);
                        jQuery("#documents_max").html(result.downloads_limit);
                        jQuery("#documents_format").html(result.downloads_formats);
                    } else {
                        jQuery("#upload_avaible_document").hide();
                        jQuery("#error_document").show();
                    }
                    // Videos
                    if (result.videos_free > 0) {
                        jQuery("#videos_free").show();
                        jQuery("#videos_free_count").html(result.videos_free);
                    } else {
                        jQuery("#videos_free").hide();
                    }
                    if (result.videos_available > 0) {
                        jQuery("#upload_avaible_video").show();
                        jQuery("#error_video").hide();
                        jQuery("#videos_left").html(result.videos_available);
                        jQuery("#videos_max").html(result.videos_limit);
                    } else {
                        jQuery("#upload_avaible_video").hide();
                        jQuery("#error_video").show();
                    }
                },
                "json"
        );
    }

    // Target url for uploads
    var url = '{uri_baseurl(/index.php)}?page={curpage}&mode=ajax&is_user_media=1&do=upload';
    // Images
    jQuery('#uploadImages').fileupload({
        url: url,
        autoUpload: true,
        dataType: 'json',
        disableImageResize: true,
        maxFileSize: {UPLOAD_MAX_FILESIZE},
        acceptFileTypes: /Android(?!.*Chrome)|Opera/
                .test(window.navigator.userAgent),
        filesContainer: jQuery('#uploadImageTable tbody'),
        uploadTemplate: function (o) {
            jQuery("#uploadImageNoneYet").hide();
            jQuery("#uploadImageTable").show();
            var imageIndex = jQuery("#uploadImageTable tbody > tr").length;
            var rows = jQuery();
            jQuery.each(o.files, function (index, file) {
                var image = { IMAGE_INDEX: imageIndex, IMAGE_TYPE: file.type, IMAGE_DATA: '', IMAGE_DEFAULT: false };
                var templateSource = jQuery("#templateImageUpload").html();
                // Replace variables
                jQuery.each(image, function (name, value) {
                    templateSource = templateSource.replace(eval('/#'+name+'#/g'), value);
                });
                var row = jQuery(templateSource);
                rows = rows.add(row);
            });
            return rows;
        },
        downloadTemplate: function (o) {
            var rows = jQuery();
            jQuery.each(o.files, function (index, image) {
                if (typeof image.ERRORS == "undefined") {
                    var templateSource = jQuery("#templateImageDownload").html();
                    // Replace variables
                    jQuery.each(image, function (name, value) {
                        templateSource = templateSource.replace(eval('/#'+name+'#/g'), value);
                    });
                    // Add preview
                    var row = jQuery(templateSource);
                    row.find(".galleryImagePreview").append( jQuery(image.preview).addClass('img-polaroid') );
                    // Set default state
                    if (image.IMAGE_DEFAULT) {
                        row.find("a.default").addClass("active");
                    } else {
                        row.find("a.default").removeClass("active");
                    }
                    rows = rows.add(row);
                } else {
                    var templateSource = jQuery("#templateError").html();
                    // Replace variables
                    templateSource = templateSource.replace(eval('/#ERRORS#/g'), image.ERRORS.join("<br>\n"));
                    var row = jQuery(templateSource);
                    rows = rows.add(row);
                }
                // Update media usage
                UploadRefresh();
            });
            return rows;
        }
    }).prop('disabled', !jQuery.support.fileInput).parent().addClass(jQuery.support.fileInput ? undefined : 'disabled');
    // Check max upload size
    jQuery('#uploadImages').bind('fileuploadadd', function(e, data) {
        if (e.isDefaultPrevented()) {
            return false;
        }
        var uploadErrors = [];
        for (var file in data.originalFiles) {
            if (data.originalFiles[0]['size'] > {UPLOAD_MAX_FILESIZE}) {
                uploadErrors.push('[[ translation : marketplace : ad.create.media.error.size : FILENAME="'+data.originalFiles[0]['name']+'" : Die Datei "{FILENAME}" überschreitet die maximal erlaubte Größe. ]]');
            }
        }
        if(uploadErrors.length > 0) {
            alert(uploadErrors.join("\n"));
            e.preventDefault();
        } else {
            return true;
        }
    });
    
    // Documents
    jQuery('#uploadDocuments').fileupload({
        url: url,
        autoUpload: true,
        dataType: 'json',
        disableImageResize: true,
        maxFileSize: {UPLOAD_MAX_FILESIZE},
        acceptFileTypes: /Android(?!.*Chrome)|Opera/
                .test(window.navigator.userAgent),
        filesContainer: jQuery('#uploadDocumentTable tbody'),
        uploadTemplate: function (o) {
            jQuery("#uploadDocumentNoneYet").hide();
            jQuery("#uploadDocumentTable").show();
            var uploadIndex = jQuery("#uploadDocumentTable > tbody > tr").length;
            var rows = jQuery();
            jQuery.each(o.files, function (index, file) {
                var image = { UPLOAD_INDEX: uploadIndex, UPLOAD_FILE: file.name, UPLOAD_TYPE: file.type };
                var templateSource = jQuery("#templateDocumentUpload").html();
                // Replace variables
                jQuery.each(image, function (name, value) {
                    templateSource = templateSource.replace(eval('/#'+name+'#/g'), value);
                });
                var row = jQuery(templateSource);
                rows = rows.add(row);
            });
            return rows;
        },
        downloadTemplate: function (o) {
            var rows = jQuery();
            jQuery.each(o.files, function (index, image) {
                if (typeof image.ERRORS == "undefined") {
                    var templateSource = jQuery("#templateDocumentDownload").html();
                    // Replace variables
                    jQuery.each(image, function (name, value) {
                        templateSource = templateSource.replace(eval('/#'+name+'#/g'), value);
                    });
                    var row = jQuery(templateSource);
                    rows = rows.add(row);
                } else {
                    var templateSource = jQuery("#templateError").html();
                    // Replace variables
                    templateSource = templateSource.replace(eval('/#ERRORS#/g'), image.ERRORS.join("<br>\n"));
                    jQuery("#uploadDocumentErrors").append(templateSource);
                }
                // Update media usage
                UploadRefresh();
            });
            return rows;
        }
    }).prop('disabled', !jQuery.support.fileInput).parent().addClass(jQuery.support.fileInput ? undefined : 'disabled');
    // Check max upload size
    jQuery('#uploadDocuments').bind('fileuploadadd', function(e, data) {
        if (e.isDefaultPrevented()) {
            return false;
        }
        var uploadErrors = [];
        for (var file in data.originalFiles) {
            if (data.originalFiles[0]['size'] > {UPLOAD_MAX_FILESIZE}) {
                uploadErrors.push('[[ translation : marketplace : ad.create.media.error.size : FILENAME="'+data.originalFiles[0]['name']+'" : Die Datei "{FILENAME}" überschreitet die maximal erlaubte Größe. ]]');
            }
        }
        if(uploadErrors.length > 0) {
            alert(uploadErrors.join("\n"));
            e.preventDefault();
        } else {
            return true;
        }
    });

</script>